{% comment %}
  Section: features-bar (PNG version)
  Purpose: 4-up features with PNG image uploads instead of SVG icons.
  Notes:
  - Per-block PNG via image_picker
  - A11y: section landmark, aria-labelledby, focus rings
  - Self-contained CSS
  - Font consistency with theme typography
  - Enhanced mobile support: 1-4 columns
{% endcomment %}

{%- liquid
  assign heading          = section.settings.heading
  assign subheading       = section.settings.subheading
  assign max_width        = section.settings.max_width | default: 1160
  assign radius           = section.settings.icon_bg_radius | default: 14
  assign icon_size        = section.settings.icon_size | default: 24
  assign cols_desktop     = section.settings.columns_desktop | default: '4'
  assign cols_tablet      = section.settings.columns_tablet | default: '2'
  assign cols_mobile      = section.settings.columns_mobile | default: '1'
  assign gap_desktop      = section.settings.gap_desktop | default: 28
  assign gap_mobile       = section.settings.gap_mobile | default: 16
  assign pad_top          = section.settings.padding_top | default: 64
  assign pad_bottom       = section.settings.padding_bottom | default: 64
  assign align            = section.settings.align | default: 'center'
  assign show_dividers    = section.settings.show_dividers
  assign debug_mode       = section.settings.debug_mode

  assign png_wh = icon_size | times: 2
-%}

<section class="features-bar features-bar--{{ section.id }}{% if debug_mode %} debug-mode{% endif %}"
  aria-labelledby="{% if heading != blank %}features-title-{{ section.id }}{% else %}features-label-{{ section.id }}{% endif %}"
  role="region">

  <style>
    .features-bar--{{ section.id }}{
      /* Using semantic tokens from theme-toggle.css */
      --features-bar__radius: {{ radius }}px;
      --features-bar__icon-size: {{ icon_size }}px;
      --features-bar__gap: {{ gap_desktop }}px;
      --features-bar__gap-mobile: {{ gap_mobile }}px;
      --features-bar__container: {{ max_width }}px;

      background: var(--color-bg);
      padding-top: {{ pad_top }}px;
      padding-bottom: {{ pad_bottom }}px;
      font-family: inherit; /* Inherit theme fonts */
      {% if show_dividers %}
      border-top: 1px solid var(--color-border-light);
      border-bottom: 1px solid var(--color-border-light);
      {% endif %}
    }

    .features-bar--{{ section.id }} .features-bar__wrap{
      max-width: var(--features-bar__container);
      margin: 0 auto;
      padding-inline: 16px;
    }

    .features-bar--{{ section.id }} .features-bar__heading{
      color: var(--color-text-heading);
      font-family: var(--font-heading-family, inherit); /* Use theme's heading font */
      font-weight: 700;
      letter-spacing: -0.01em;
      text-align: {{ align }};
      margin: 0 0 20px 0px;
      font-size: clamp(1.5rem, 2vw + 1rem, 2rem);
      line-height: 1.2;
    }

    .features-bar--{{ section.id }} .features-bar__subheading{
      color: var(--color-text-secondary);
      font-family: var(--font-body-family, inherit); /* Use theme's body font */
      text-align: {{ align }};
      margin: 0 0 28px 0;
      line-height: 1.6;
    }

    .features-bar--{{ section.id }} .features-bar__grid{
      display: grid;
      gap: var(--features-bar__gap);
      align-items: start;
      justify-items: center;
      grid-template-columns: repeat({{ cols_desktop }}, minmax(0,1fr));
    }
    @media (max-width: 1024px){
      .features-bar--{{ section.id }} .features-bar__grid{
        grid-template-columns: repeat({{ cols_tablet }}, minmax(0,1fr));
      }
    }
    @media (max-width: 640px){
      .features-bar--{{ section.id }} .features-bar__grid{
        grid-template-columns: repeat({{ cols_mobile }}, minmax(0,1fr));
        gap: var(--features-bar__gap-mobile);
      }
      .features-bar--{{ section.id }} .features-bar__subheading{ margin-bottom: 20px; }
      
      /* Hide individual features on mobile based on block setting */
      .features-bar--{{ section.id }} .features-bar__item[data-hide-mobile="true"]{
        display: none;
      }
      
      /* Adjust icon and text sizing for 3-4 column mobile layouts */
      {% if cols_mobile == '3' or cols_mobile == '4' %}
      .features-bar--{{ section.id }} .features-bar__icon{
        width: 48px;
        height: 48px;
      }
      .features-bar--{{ section.id }} .features-bar__icon img{
        width: calc(var(--features-bar__icon-size) * 1.5);
      }
      .features-bar--{{ section.id }} .features-bar__title{
        font-size: 1rem;
      }
      .features-bar--{{ section.id }} .features-bar__desc{
        font-size: 0.875rem;
      }
      {% endif %}
    }

    .features-bar--{{ section.id }} .features-bar__item{
      width: 100%;
      text-align: {{ align }};
      font-family: inherit; /* Ensure font inheritance */
      background-color: transparent;
      padding: 20px;
      border-radius: 12px;
    }

    .features-bar--{{ section.id }} .features-bar__link{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-body-family, inherit); /* Use theme's body font for links */
      font-weight: 600;
      text-decoration: none;
      color: var(--color-text-heading);
      outline: none;
      border-radius: 10px;
      padding: 2px 4px;
    }
    .features-bar--{{ section.id }} .features-bar__link:focus-visible{
      box-shadow: 0 0 0 var(--ring-width) var(--ring-color-alpha);
    }

    .features-bar--{{ section.id }} .features-bar__icon{
      width: 64px; height: 64px;
      display: inline-grid;
      place-items: center;
      border-radius: var(--features-bar__radius);
      background: linear-gradient(180deg, var(--color-primary), var(--color-secondary));
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
      transition: transform .18s ease, box-shadow .18s ease;
      margin: 0 auto 12px auto;
      overflow: hidden;
    }
    .features-bar--{{ section.id }} .features-bar__icon img{
      width: calc(var(--features-bar__icon-size) * 2);
      height: auto;
      display: block;
    }
    .features-bar--{{ section.id }} .features-bar__item:hover .features-bar__icon{
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
    }
    .features-bar--{{ section.id }} .features-bar__focusable:focus-visible .features-bar__icon{
      box-shadow: 0 0 0 var(--ring-width) var(--ring-color-alpha), 0 6px 14px rgba(0,0,0,.08);
      transform: translateY(-1px);
    }

    .features-bar--{{ section.id }} .features-bar__title{
      color: var(--color-text-heading);
      font-family: var(--font-heading-family, inherit); /* Use theme's heading font for feature titles */
      font-weight: 600;
      margin: 0 0 6px 0;
      font-size: 1.2rem;
      line-height: 1.35;
    }
    .features-bar--{{ section.id }} .features-bar__desc{
      color: var(--color-text-secondary);
      font-family: var(--font-body-family, inherit); /* Use theme's body font for descriptions */
      margin: 0;
      font-size: 1rem;
      line-height: 1.55;
    }

    /* Ensure all elements inherit theme typography */
    .features-bar--{{ section.id }} *{
      font-family: inherit;
    }

    /* Override specific elements with theme font variables */
    .features-bar--{{ section.id }} h2,
    .features-bar--{{ section.id }} h3,
    .features-bar--{{ section.id }} .features-bar__heading,
    .features-bar--{{ section.id }} .features-bar__title{
      font-family: var(--font-heading-family, inherit);
    }

    .features-bar--{{ section.id }} p,
    .features-bar--{{ section.id }} div,
    .features-bar--{{ section.id }} a,
    .features-bar--{{ section.id }} .features-bar__subheading,
    .features-bar--{{ section.id }} .features-bar__desc,
    .features-bar--{{ section.id }} .features-bar__link{
      font-family: var(--font-body-family, inherit);
    }

    {% if align == 'left' %}
    .features-bar--{{ section.id }} .features-bar__item{ text-align: left; }
    .features-bar--{{ section.id }} .features-bar__icon{ margin-left: 0; }
    {% endif %}

    {% if debug_mode %}
    /* Debug Mode Styles */
    .features-bar--{{ section.id }}.debug-mode {
      position: relative;
      outline: 3px dashed #ff0000;
      outline-offset: -3px;
    }
    .features-bar--{{ section.id }}.debug-mode::before {
      content: 'SECTION BG: {{ bg }}';
      position: absolute;
      top: 5px;
      left: 5px;
      background: #ff0000;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      z-index: 1000;
      font-family: monospace;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__wrap {
      outline: 2px dashed #00ff00;
      outline-offset: -2px;
      position: relative;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__wrap::before {
      content: 'WRAP: max-width {{ max_width }}px';
      position: absolute;
      top: -18px;
      left: 0;
      background: #00ff00;
      color: black;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      z-index: 1000;
      font-family: monospace;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__grid {
      outline: 2px dashed #0066ff;
      outline-offset: -2px;
      position: relative;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__grid::before {
      content: 'GRID: gap {{ gap_desktop }}px';
      position: absolute;
      top: -18px;
      right: 0;
      background: #0066ff;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      z-index: 1000;
      font-family: monospace;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__item {
      outline: 2px solid #ff9900;
      outline-offset: -2px;
      position: relative;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__item::before {
      content: 'CONTAINER BG: {{ item_bg }}';
      position: absolute;
      top: 2px;
      left: 2px;
      background: #ff9900;
      color: black;
      font-size: 9px;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 1000;
      font-family: monospace;
      white-space: nowrap;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__icon {
      outline: 2px solid #9900ff;
      outline-offset: -2px;
      position: relative;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__icon::after {
      content: 'ICON: {{ blue_start }} â†’ {{ blue_end }}';
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      background: #9900ff;
      color: white;
      font-size: 8px;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 1000;
      font-family: monospace;
      white-space: nowrap;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__title {
      outline: 2px solid #00cccc;
      outline-offset: -1px;
      position: relative;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__title::after {
      content: 'TITLE: {{ head_color }}';
      position: absolute;
      top: -16px;
      left: 0;
      background: #00cccc;
      color: black;
      font-size: 8px;
      padding: 1px 4px;
      border-radius: 3px;
      z-index: 1000;
      font-family: monospace;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__desc {
      outline: 2px solid #cc6600;
      outline-offset: -1px;
      position: relative;
    }
    .features-bar--{{ section.id }}.debug-mode .features-bar__desc::after {
      content: 'DESC: {{ text_color }}';
      position: absolute;
      bottom: -16px;
      left: 0;
      background: #cc6600;
      color: white;
      font-size: 8px;
      padding: 1px 4px;
      border-radius: 3px;
      z-index: 1000;
      font-family: monospace;
    }
    /* Debug Copy Button */
    .features-bar--{{ section.id }}.debug-mode .debug-copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #1a1a2e;
      color: #4ecdc4;
      border: 2px solid #4ecdc4;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      font-family: monospace;
      z-index: 1001;
      transition: all 0.2s;
    }
    .features-bar--{{ section.id }}.debug-mode .debug-copy-btn:hover {
      background: #4ecdc4;
      color: #1a1a2e;
    }
    {% endif %}
  </style>

  {% if debug_mode %}
  <button class="debug-copy-btn" onclick="copyFeaturesDebug_{{ section.id | replace: '-', '_' }}()">ðŸ“‹ Copy Debug</button>
  <textarea id="debug-data-{{ section.id }}" style="position:absolute;left:-9999px;">FEATURES-BAR DEBUG REPORT
==========================
Section ID: {{ section.id }}
Time: {{ 'now' | date: '%Y-%m-%d %H:%M:%S' }}

CONTAINER BACKGROUND ISSUE
--------------------------
Setting: item_bg_color
Value: {{ section.settings.item_bg_color | default: 'NOT SET' }}
Processed: {{ item_bg }}
Is Blank: {% if item_bg == blank %}true{% else %}false{% endif %}
Length: {{ item_bg | size }} chars

CSS VARIABLES
-------------
--features-bar__bg: {{ bg }}
--features-bar__head: {{ head_color }}
--features-bar__text: {{ text_color }}
--features-bar__item-bg: {{ item_bg }}
--features-bar__blue-start: {{ blue_start }}
--features-bar__blue-end: {{ blue_end }}
--features-bar__radius: {{ radius }}px
--features-bar__icon-size: {{ icon_size }}px
--features-bar__gap: {{ gap_desktop }}px
--features-bar__container: {{ max_width }}px

CSS RULE
--------
.features-bar__item {
  background-color: var(--features-bar__item-bg);
  padding: 20px;
  border-radius: 12px;
}

EXPECTED: background-color: {{ item_bg }}</textarea>
  <script>
  function copyFeaturesDebug_{{ section.id | replace: '-', '_' }}(){
    var t=document.getElementById('debug-data-{{ section.id }}');
    t.style.left='0';t.select();document.execCommand('copy');t.style.left='-9999px';
    var b=event.target;b.textContent='âœ“ Copied!';b.style.background='#a8e6cf';b.style.color='#1a1a2e';
    setTimeout(function(){b.textContent='ðŸ“‹ Copy Debug';b.style.background='#1a1a2e';b.style.color='#4ecdc4';},2000);
  }
  </script>
  {% endif %}

  <div class="features-bar__wrap">
    {% if heading != blank %}
      <h2 id="features-title-{{ section.id }}" class="features-bar__heading">{{ heading | escape }}</h2>
    {% else %}
      <span id="features-label-{{ section.id }}" class="visually-hidden">Features</span>
    {% endif %}

    {% if subheading != blank %}
      <div class="features-bar__subheading">{{ subheading }}</div>
    {% endif %}

    <div
        id="features-bar__grid-{{ section.id }}"
        class="features-bar__grid"
        role="list"
        aria-roledescription="list"
        aria-label="{{ heading | default: 'Features' | escape }}"
    >
      {%- for block in section.blocks -%}
        {%- liquid
          assign img            = block.settings.icon_png
          assign img_alt        = block.settings.icon_png_alt
          assign icon_bg_custom = block.settings.icon_bg_custom
          assign title          = block.settings.title
          assign desc           = block.settings.description
          assign link_label     = block.settings.link_label
          assign link_url       = block.settings.link_url
          assign aria_label     = block.settings.aria_label
          assign icon_only      = block.settings.icon_only
          assign hide_mobile    = block.settings.hide_on_mobile | default: false
        -%}

        {%- capture icon_markup -%}
          <div class="features-bar__icon" style="{% if icon_bg_custom != blank %}background: {{ icon_bg_custom }};{% endif %}">
            {%- if img != blank -%}
              <img
                srcset="{{ img | image_url: width: 64 }} 64w, {{ img | image_url: width: 96 }} 96w, {{ img | image_url: width: 128 }} 128w"
                src="{{ img | image_url: width: 96 }}"
                width="{{ png_wh }}" height="{{ png_wh }}"
                alt="{{ img_alt | escape }}"
                loading="lazy">
            {%- else -%}
              <img src="{{ 'placeholder-image.png' | asset_url }}" alt="" width="{{ png_wh }}" height="{{ png_wh }}" loading="lazy" style="opacity:.0">
            {%- endif -%}
          </div>
        {%- endcapture -%}

        <div class="features-bar__item" role="listitem" data-hide-mobile="{{ hide_mobile }}" {{ block.shopify_attributes }}>
          {%- assign link_open = '' -%}
          {%- assign link_close = '' -%}
          {%- if link_url != blank -%}
            {%- assign computed_label = aria_label | default: title -%}
            {%- capture link_open -%}<a class="features-bar__link features-bar__focusable" href="{{ link_url }}" aria-label="{{ computed_label | escape }}">{%- endcapture -%}
            {%- assign link_close = '</a>' -%}
          {%- endif -%}

          {{ link_open }}
            {{ icon_markup }}
            {%- unless icon_only -%}
              {%- if title != blank -%}
                <h3 class="features-bar__title">{{ title | escape }}</h3>
              {%- endif -%}
            {%- endunless -%}
          {{ link_close }}

          {%- unless icon_only -%}
            {%- if desc != blank -%}
              <p class="features-bar__desc">{{ desc | escape }}</p>
            {%- endif -%}
          {%- endunless -%}
        </div>
      {%- endfor -%}
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Features Bar",
  "tag": "section",
  "class": "section features-bar",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Wholesale program benefits" },
    { "type": "richtext", "id": "subheading", "label": "Subheading", "default": "<p>Access exclusive savings and support designed for growing businesses.</p>" },
    { "type": "range", "id": "max_width", "min": 800, "max": 1400, "step": 10, "unit": "px", "label": "Max content width", "default": 1160 },

    { "type": "paragraph", "content": "Colors are managed by the theme color scheme (see COLOR_SCHEME.md)" },

    { "type": "range", "id": "icon_bg_radius", "min": 8, "max": 20, "step": 1, "unit": "px", "label": "Tile corner radius", "default": 14 },
    { "type": "range", "id": "icon_size", "min": 20, "max": 36, "step": 1, "unit": "px", "label": "PNG scale (base unit)", "default": 24 },

    { "type": "select", "id": "columns_desktop", "label": "Columns on desktop", "options": [ { "value": "3", "label": "3" }, { "value": "4", "label": "4" } ], "default": "4" },
    { "type": "select", "id": "columns_tablet", "label": "Columns on tablet", "options": [ { "value": "2", "label": "2" }, { "value": "3", "label": "3" } ], "default": "2" },
    { "type": "select", "id": "columns_mobile", "label": "Columns on mobile", "options": [ 
      { "value": "1", "label": "1" }, 
      { "value": "2", "label": "2" },
      { "value": "3", "label": "3" },
      { "value": "4", "label": "4" }
    ], "default": "1" },

    { "type": "range", "id": "gap_desktop", "min": 16, "max": 40, "step": 1, "unit": "px", "label": "Grid gap (desktop)", "default": 28 },
    { "type": "range", "id": "gap_mobile", "min": 8, "max": 24, "step": 1, "unit": "px", "label": "Grid gap (mobile)", "default": 16 },

    { "type": "range", "id": "padding_top", "min": 0, "max": 120, "step": 2, "unit": "px", "label": "Padding top", "default": 64 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 120, "step": 2, "unit": "px", "label": "Padding bottom", "default": 64 },

    { "type": "select", "id": "align", "label": "Text alignment", "options": [ { "value": "center", "label": "Center" }, { "value": "left", "label": "Left" } ], "default": "center" },

    { "type": "checkbox", "id": "show_dividers", "label": "Show faint top/bottom dividers", "default": false },
    { "type": "checkbox", "id": "debug_mode", "label": "ðŸ”§ Debug Mode (show element colors)", "default": false }
  ],
  "blocks": [
    {
      "type": "feature",
      "name": "Feature",
      "settings": [
        { "type": "image_picker", "id": "icon_png", "label": "PNG icon (recommended transparent background)" },
        { "type": "text", "id": "icon_png_alt", "label": "PNG alt text (leave blank if decorative)" },
        { "type": "color", "id": "icon_bg_custom", "label": "Tile background override (optional)" },

        { "type": "text", "id": "title", "label": "Title", "default": "Feature title" },
        { "type": "textarea", "id": "description", "label": "Description", "default": "Short supporting copy about the benefit." },

        { "type": "text", "id": "link_label", "label": "Link label (optional)" },
        { "type": "url", "id": "link_url", "label": "Link URL (optional)" },
        { "type": "text", "id": "aria_label", "label": "Accessible label (if linked)" },

        { "type": "checkbox", "id": "icon_only", "label": "Icon only (hide text)", "default": false },
        { "type": "checkbox", "id": "hide_on_mobile", "label": "Hide this feature on mobile", "default": false }
      ]
    }
  ],
  "max_blocks": 8,
  "presets": [
    {
      "name": "Features Bar",
      "category": "Text",
      "settings": {
        "heading": "Wholesale program benefits",
        "subheading": "<p>Access exclusive savings and support designed for growing businesses.</p>"
      },
      "blocks": [
        { "type": "feature", "settings": { "title": "Authorized Distributor", "description": "Direct partnerships with top manufacturers" } },
        { "type": "feature", "settings": { "title": "Exclusive Wholesale Discounts", "description": "Up to 30% savings on bulk orders" } },
        { "type": "feature", "settings": { "title": "Dedicated Support", "description": "Personal wholesale account management" } },
        { "type": "feature", "settings": { "title": "Nationwide Delivery", "description": "Fast shipping across the United States" } }
      ]
    }
  ]
}
{% endschema %}